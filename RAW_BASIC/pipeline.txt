pipeline {

    agent any
    
    environment {
        //relativ zum Workspace
        PROGRAM = "/liquibase_4.4.3/liquibase"
        PROPERTY_FILE = 'RAW_BASIC/liquibase.properties'
        GIT_URL = 'https://github.com/micpage/CICD'
        GIT_CREDENTIALS = 'github'
        DB_CREDENTIALS  = 'db2inst1'
        JIRA_ID = 'DB2LUW-4322'
    }
    
    stages {
        stage ('checkout git repository'){
            steps{
                checkout([$class: 'GitSCM', branches: [[name: '*/master']], extensions: [], userRemoteConfigs: [[credentialsId: "$GIT_CREDENTIALS", url: "$GIT_URL"]]])
            }
        }
        stage ('pre checks') {
            steps {
                withCredentials([usernamePassword(credentialsId: "$DB_CREDENTIALS", passwordVariable: 'DB_PASSWORD', usernameVariable: 'DB_USERNAME')]) {
                    sh "${PROGRAM} --defaults-file=${PROPERTY_FILE} --username=$DB_USERNAME --password=$DB_PASSWORD validate"
                    sh "${PROGRAM} --defaults-file=${PROPERTY_FILE} --username=$DB_USERNAME --password=$DB_PASSWORD list-locks"
                    sh "${PROGRAM} --defaults-file=${PROPERTY_FILE} --username=$DB_USERNAME --password=$DB_PASSWORD history"
                    sh "${PROGRAM} --defaults-file=${PROPERTY_FILE} --username=$DB_USERNAME --password=$DB_PASSWORD status"
                }
            }
        }
        stage ('update-sql') {
            steps {
                withCredentials([usernamePassword(credentialsId: "$DB_CREDENTIALS", passwordVariable: 'DB_PASSWORD', usernameVariable: 'DB_USERNAME')]) {
                    sh "${PROGRAM} --defaults-file=${PROPERTY_FILE} --username=$DB_USERNAME --password=$DB_PASSWORD update-sql"
                }
            }
        }
        stage ('update') {
            steps {
                withCredentials([usernamePassword(credentialsId: "$DB_CREDENTIALS", passwordVariable: 'DB_PASSWORD', usernameVariable: 'DB_USERNAME')]) {
                    sh "${PROGRAM} --defaults-file=${PROPERTY_FILE} --username=$DB_USERNAME --password=$DB_PASSWORD --log-level=INFO --log-file=${env.JOB_BASE_NAME}_${env.BUILD_ID}_update.log update"
                }
            }
        }
        stage ('history') {
            steps {
                withCredentials([usernamePassword(credentialsId: "$DB_CREDENTIALS", passwordVariable: 'DB_PASSWORD', usernameVariable: 'DB_USERNAME')]) {
                    sh "${PROGRAM} --defaults-file=${PROPERTY_FILE} --username=$DB_USERNAME --password=$DB_PASSWORD history"
                }
            }
        }
        /*
        stage ('Update Jira') {
            steps {
                jiraAddComment comment: "Jenkins-Pipeline bei Jenkins ${env.JOB_BASE_NAME} ${env.BUILD_ID} ausgef√ºhrt", failOnError: false, idOrKey: "${JIRA_ID}", site: 'VERA'
                jiraUploadAttachment failOnError: false, file: "${env.JOB_BASE_NAME}_${env.BUILD_ID}_update.log", idOrKey: "${JIRA_ID}", site: 'VERA'
            }
        }
        */
        /*
        stage('Email') {
            steps {
                emailext body: "Test-Email von Jenkins ${env.JOB_BASE_NAME} ${env.BUILD_ID}", subject: 'Test Jenkins', to: 'email@mail.intern'
            }

        }
        */
    }
}
    
    
